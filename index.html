<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labo Chromatographie de la Neige</title>

    <!--  ============================================================
          CONFIGURATION — Modifier les données ici
          ============================================================ -->
    <script>
    var CONFIG = {
        xAxis:  { label: "Temps de retention", unit: "min", min: 0, max: 10, ticks: 10 },
        yAxis:  { label: "Intensitée",          unit: "mAU", min: 0, max: 120 },
        animationDuration: 35000,
        noiseLevel: 0.025,
        numPoints:  800
    };

    var SAMPLES = [
        /* --- R\u00e9f\u00e9rence (neige pure) --- */
        {
            name:     "Neige fraîche de montagne",
            subtitle: "Contrôle / Référence",
            code:     "REF",
            color:    "#42A5F5",
            cardBg:   "#E3F2FD",
            peaks: [
                { position: 1.4, height: 14, width: 0.12, label: "H\u2082O" }
            ]
        },
        /* --- Site 1 --- */
        {
            name:     "Site 1",
            subtitle: "Echantillon n\u00b01",
            code:     "S1",
            location: "Bord de route",
            color:    "#FF9800",
            cardBg:   "#FFF3E0",
            peaks: [
                { position: 1.4, height: 14, width: 0.12, label: "H\u2082O" },
                { position: 3.1, height: 82, width: 0.18, label: "NaCl" },
                { position: 5.0, height: 35, width: 0.16, label: "Suie" },
                { position: 7.3, height: 13, width: 0.20, label: "Huile" }
            ]
        },
        /* --- Site 2 --- */
        {
            name:     "Site 2",
            subtitle: "Echantillon n\u00b02",
            code:     "S2",
            location: "Centre-ville",
            color:    "#66BB6A",
            cardBg:   "#E8F5E9",
            peaks: [
                { position: 1.4, height: 14, width: 0.12, label: "H\u2082O" },
                { position: 3.1, height: 42, width: 0.18, label: "NaCl" },
                { position: 5.0, height: 26, width: 0.16, label: "Suie" },
                { position: 7.3, height: 13, width: 0.20, label: "Huile" }
            ]
        },
        /* --- Site 3 --- */
        {
            name:     "Site 3",
            subtitle: "Echantillon n\u00b03",
            code:     "S3",
            location: "Zone industrielle",
            color:    "#EF5350",
            cardBg:   "#FFEBEE",
            peaks: [
                { position: 1.4, height: 14, width: 0.12, label: "H\u2082O" },
                { position: 3.1, height: 42, width: 0.18, label: "NaCl" },
                { position: 5.0, height: 26, width: 0.16, label: "Suie" },
                { position: 7.3, height: 13, width: 0.20, label: "Huile" }
            ]
        }
    ];
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #eef0f4;
            height: 100vh;
            overflow: hidden;
        }

        /* ---- Page system ---- */
        .page {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .page.hidden {
            opacity: 0; pointer-events: none; transform: translateY(12px);
        }

        /* =============== PAGE 1 =============== */
        #page1 {
            align-items: center; justify-content: center; padding: 14px;
        }
        .p1-title {
            color: #2c3e50; font-size: 1.45em; font-weight: 600;
            letter-spacing: -0.01em;
        }
        .p1-sub {
            color: #6b7c8d; font-size: 0.82em; margin: 5px 0 14px;
            text-align: center;
        }

        .map-container {
            position: relative; width: 100%; max-width: 860px;
            border-radius: 6px; overflow: hidden;
            box-shadow: 0 1px 8px rgba(0,0,0,0.1);
            border: 1px solid #c8cdd4;
        }
        .map-container svg { display: block; width: 100%; height: auto; }

        .zone-area { cursor: pointer; }
        .zone-fill {
            transition: fill-opacity 0.3s ease, stroke-opacity 0.3s ease;
            stroke-width: 2; stroke-opacity: 0;
        }
        .zone-area:hover .zone-fill {
            fill-opacity: 0.3;
            stroke-opacity: 0.5;
        }
        .zone-label-bg { transition: opacity 0.3s; opacity: 0.65; }
        .zone-area:hover .zone-label-bg { opacity: 0.95; }

        /* =============== PAGE 2 =============== */
        #page2 { padding: 6px 14px 8px; }

        .p2-header {
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0; padding: 2px 0;
        }
        .p2-header h1 {
            color: #2c3e50; font-size: 1.1em; font-weight: 600;
            flex: 1; text-align: center;
        }
        .p2-btn {
            background: #4a6785; color: white; border: none;
            padding: 5px 14px; border-radius: 4px; font-size: 0.75em;
            cursor: pointer; transition: background 0.2s;
            letter-spacing: 0.01em;
        }
        .p2-btn:hover { background: #3a5470; }
        .p2-btn.primary { background: #2979FF; }
        .p2-btn.primary:hover { background: #2062cc; }

        .controls {
            display: flex; justify-content: center; gap: 8px;
            padding: 2px 0 5px; flex-shrink: 0;
        }
        .p2-sub {
            text-align: center; color: #8895a4; font-size: 0.7em;
            padding: 0 0 4px; flex-shrink: 0;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        #app {
            flex: 1; display: flex; flex-direction: column;
            gap: 4px; min-height: 0;
        }

        .row {
            flex: 1; display: flex; align-items: stretch;
            background: #fff; border-radius: 5px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            overflow: hidden; border: 1px solid #d4d8de;
            transition: border-color 0.2s; min-height: 0;
        }
        .row:hover { border-color: #a0b4c8; }

        .sample-card {
            width: 115px; min-width: 115px; padding: 4px 6px;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; cursor: pointer; user-select: none;
            border-right: 1px solid #e4e7eb; transition: background 0.15s;
        }
        .sample-card:hover { background: #f6f7f9; }
        .sample-card:active { transform: scale(0.97); }
        .sample-card .code {
            font-family: 'Consolas', monospace; font-size: 0.6em;
            font-weight: 700; color: #fff; padding: 2px 7px;
            border-radius: 3px; letter-spacing: 0.03em;
        }
        .sample-card .name {
            font-weight: 600; font-size: 0.65em; text-align: center;
            color: #2c3e50; line-height: 1.15; margin-top: 2px;
        }
        .sample-card .subtitle {
            font-family: 'Consolas', monospace; font-size: 0.54em;
            color: #8895a4; text-align: center; margin-top: 1px;
        }

        .graph-area {
            flex: 1; position: relative; min-height: 0;
            background: #f5f6f9; border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        .graph-area canvas { display: block; width: 100%; height: 100%; }

        .graph-hint {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); color: #99a3ad;
            font-size: 0.72em; pointer-events: none;
            font-family: 'Consolas', monospace;
            animation: pulse 2.5s ease-in-out infinite;
            transition: opacity 0.3s;
        }
        .graph-hint.hidden { opacity: 0; }
        @keyframes pulse { 0%,100% { opacity: 0.3; } 50% { opacity: 0.8; } }

        #tooltip {
            position: fixed; background: rgba(30,36,44,0.94); color: #fff;
            padding: 5px 10px; border-radius: 4px; font-size: 0.74em;
            pointer-events: none; z-index: 100; white-space: nowrap;
            transform: translate(-50%, calc(-100% - 10px));
            line-height: 1.3; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: opacity 0.12s;
            font-family: 'Consolas', monospace;
        }
        #tooltip.hidden { opacity: 0; pointer-events: none; }
        .tt-name { font-weight: 700; font-size: 1.05em; font-family: 'Segoe UI', sans-serif; }
        .tt-value { color: #a0b4c8; font-size: 0.9em; }
    </style>
</head>
<body>

<!-- ============== PAGE 1 ============== -->
<div class="page" id="page1">
    <h1 class="p1-title">Chromatographie de la Neige</h1>
    <p class="p1-sub">S&eacute;lectionnez un site de pr&eacute;l&egrave;vement &agrave; comparer avec l'&eacute;chantillon de r&eacute;f&eacute;rence</p>
    <div class="map-container">
        <svg viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="skyGrad" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stop-color="#cddae5"/>
                    <stop offset="100%" stop-color="#e2e8ee"/>
                </linearGradient>
            </defs>
            <rect width="800" height="400" fill="url(#skyGrad)"/>

            <!-- Mountain body -->
            <polygon points="40,355 120,260 200,220 300,140 400,60 500,140 600,220 680,260 760,355"
                     fill="#8a9baa" opacity="0.5"/>
            <!-- Far ridge (depth) -->
            <path d="M0,355 Q100,310 200,280 Q300,230 400,120 Q500,230 600,280 Q700,310 800,355"
                  fill="#7a8b99" opacity="0.2"/>

            <!-- Snow on peak -->
            <polygon points="375,88 400,60 425,88" fill="#fff" opacity="0.8"/>
            <polygon points="358,112 400,60 442,112" fill="#fff" opacity="0.3"/>

            <!-- Contour lines -->
            <path d="M100,300 Q250,240 400,200 Q550,240 700,300" fill="none" stroke="#6b7c8d" stroke-width="0.4" opacity="0.2"/>
            <path d="M160,270 Q280,210 400,168 Q520,210 640,270" fill="none" stroke="#6b7c8d" stroke-width="0.4" opacity="0.18"/>
            <path d="M220,242 Q310,185 400,140 Q490,185 580,242" fill="none" stroke="#6b7c8d" stroke-width="0.4" opacity="0.15"/>

            <!-- Ground / valley -->
            <rect x="0" y="350" width="800" height="50" fill="#dde3e8" opacity="0.8"/>
            <ellipse cx="160" cy="362" rx="50" ry="5" fill="#fff" opacity="0.25"/>
            <ellipse cx="400" cy="365" rx="60" ry="5" fill="#fff" opacity="0.2"/>
            <ellipse cx="650" cy="360" rx="45" ry="5" fill="#fff" opacity="0.25"/>

            <!-- Trees -->
            <g fill="#7a9a7e" opacity="0.22">
                <polygon points="68,345 74,326 80,345"/>
                <polygon points="92,342 97,327 102,342"/>
                <polygon points="700,343 706,324 712,343"/>
                <polygon points="726,340 731,326 736,340"/>
                <polygon points="238,348 243,336 248,348"/>
                <polygon points="558,346 563,334 568,346"/>
            </g>

            <!-- Grid overlay -->
            <g stroke="#9aa8b4" stroke-width="0.3" opacity="0.1">
                <line x1="0" y1="100" x2="800" y2="100"/>
                <line x1="0" y1="200" x2="800" y2="200"/>
                <line x1="0" y1="300" x2="800" y2="300"/>
                <line x1="200" y1="0" x2="200" y2="400"/>
                <line x1="400" y1="0" x2="400" y2="400"/>
                <line x1="600" y1="0" x2="600" y2="400"/>
            </g>

            <!-- Snow particles -->
            <g fill="#fff" opacity="0.3">
                <circle cx="55" cy="38" r="1.5"/><circle cx="180" cy="62" r="1.5"/>
                <circle cx="310" cy="28" r="2"/><circle cx="430" cy="48" r="1.5"/>
                <circle cx="560" cy="22" r="1.5"/><circle cx="660" cy="58" r="1.5"/>
                <circle cx="740" cy="32" r="1.5"/><circle cx="125" cy="88" r="1.5"/>
            </g>

            <!-- ===== ZONE 1: Left slope — Bord de route ===== -->
            <g class="zone-area" onclick="selectSite(1)">
                <polygon class="zone-fill" points="40,355 120,260 200,220 280,156 280,355"
                         fill="#E67E22" fill-opacity="0.08" stroke="#E67E22"/>
                <!-- Ski run -->
                <path d="M258,172 C228,228 188,288 128,345" fill="none"
                      stroke="#fff" stroke-width="1.8" stroke-dasharray="8,5" opacity="0.4"/>
                <!-- Label -->
                <rect class="zone-label-bg" x="110" y="268" width="90" height="34" rx="3" fill="#fff"/>
                <text id="zname1" x="155" y="282" text-anchor="middle" font-family="Consolas,monospace"
                      font-size="11" font-weight="700" fill="#2c3e50"></text>
                <text id="zloc1" x="155" y="295" text-anchor="middle" font-family="Consolas,monospace"
                      font-size="7.5" fill="#6b7c8d"></text>
            </g>

            <!-- ===== ZONE 2: Center slope — Centre-ville ===== -->
            <g class="zone-area" onclick="selectSite(2)">
                <polygon class="zone-fill" points="280,156 300,140 400,60 500,140 520,156 520,355 280,355"
                         fill="#27AE60" fill-opacity="0.08" stroke="#27AE60"/>
                <!-- Ski run -->
                <path d="M400,78 C396,180 398,270 400,345" fill="none"
                      stroke="#fff" stroke-width="1.8" stroke-dasharray="8,5" opacity="0.4"/>
                <!-- Label -->
                <rect class="zone-label-bg" x="352" y="230" width="96" height="34" rx="3" fill="#fff"/>
                <text id="zname2" x="400" y="244" text-anchor="middle" font-family="Consolas,monospace"
                      font-size="11" font-weight="700" fill="#2c3e50"></text>
                <text id="zloc2" x="400" y="257" text-anchor="middle" font-family="Consolas,monospace"
                      font-size="7.5" fill="#6b7c8d"></text>
            </g>

            <!-- ===== ZONE 3: Right slope — Zone industrielle ===== -->
            <g class="zone-area" onclick="selectSite(3)">
                <polygon class="zone-fill" points="520,156 600,220 680,260 760,355 520,355"
                         fill="#C0392B" fill-opacity="0.08" stroke="#C0392B"/>
                <!-- Ski run -->
                <path d="M542,172 C572,228 612,288 672,345" fill="none"
                      stroke="#fff" stroke-width="1.8" stroke-dasharray="8,5" opacity="0.4"/>
                <!-- Label -->
                <rect class="zone-label-bg" x="572" y="268" width="112" height="34" rx="3" fill="#fff"/>
                <text id="zname3" x="628" y="282" text-anchor="middle" font-family="Consolas,monospace"
                      font-size="11" font-weight="700" fill="#2c3e50"></text>
                <text id="zloc3" x="628" y="295" text-anchor="middle" font-family="Consolas,monospace"
                      font-size="7.5" fill="#6b7c8d"></text>
            </g>

            <!-- Zone dividers -->
            <line x1="280" y1="156" x2="280" y2="355" stroke="#5a6a78" stroke-width="0.5" stroke-dasharray="4,3" opacity="0.2"/>
            <line x1="520" y1="156" x2="520" y2="355" stroke="#5a6a78" stroke-width="0.5" stroke-dasharray="4,3" opacity="0.2"/>

            <!-- Reference label at peak -->
            <text x="400" y="48" text-anchor="middle" font-family="Consolas,monospace"
                  font-size="9" fill="#4a6785" font-weight="600" opacity="0.6">R&#233;f. &#8212; Neige pure</text>
        </svg>
    </div>
</div>

<!-- ============== PAGE 2 ============== -->
<div class="page hidden" id="page2">
    <div class="p2-header">
        <button class="p2-btn" onclick="goBack()">&#8592; Retour</button>
        <h1 id="p2Title">Analyse comparative</h1>
        <span style="width:76px"></span>
    </div>
    <p class="p2-sub" id="p2Sub"></p>
    <div class="controls">
        <button class="p2-btn primary" onclick="analyzeBoth()">Analyser</button>
        <button class="p2-btn" onclick="resetBoth()">R&eacute;initialiser</button>
    </div>
    <div id="app">
        <div class="row">
            <div class="sample-card" id="card0" onclick="analyzeBoth()"></div>
            <div class="graph-area" id="graphArea0" onclick="analyzeBoth()">
                <canvas id="canvas0"></canvas>
                <div class="graph-hint" id="hint0">Cliquer pour analyser</div>
            </div>
        </div>
        <div class="row">
            <div class="sample-card" id="card1" onclick="analyzeBoth()"></div>
            <div class="graph-area" id="graphArea1" onclick="analyzeBoth()">
                <canvas id="canvas1"></canvas>
                <div class="graph-hint" id="hint1">Cliquer pour analyser</div>
            </div>
        </div>
    </div>
</div>

<div id="tooltip" class="hidden"></div>

<script>
/* ============================================================= */

var MARGIN = { top: 8, right: 12, bottom: 26, left: 44 };
var tooltip = document.getElementById("tooltip");

var selectedSiteIndex = 1;
var revealFrac = 0;
var animRafId = null;
var animating = false;

var rows = [
    { sample: null, canvas: null, display: null, signal: null, hoveredPeak: null },
    { sample: null, canvas: null, display: null, signal: null, hoveredPeak: null }
];

/* ---- noise -------------------------------------------------- */
function smoothNoise(n, cp, amp) {
    var rng = Array.from({ length: cp + 1 }, function() { return (Math.random() - 0.5) * 2 * amp; });
    var out = new Array(n);
    for (var i = 0; i < n; i++) {
        var t = (i / n) * cp, idx = Math.floor(t), f = t - idx, s = f * f * (3 - 2 * f);
        out[i] = rng[idx] * (1 - s) + rng[Math.min(idx + 1, cp)] * s;
    }
    return out;
}

/* ---- signal ------------------------------------------------- */
function genSignal(sample) {
    var N = CONFIG.numPoints, xMin = CONFIG.xAxis.min, xR = CONFIG.xAxis.max - xMin;
    var amp = CONFIG.noiseLevel * CONFIG.yAxis.max;
    var sl = smoothNoise(N, 15, amp * 0.6), fa = smoothNoise(N, 180, amp * 0.4);
    var sig = new Array(N);
    for (var i = 0; i < N; i++) {
        var x = xMin + (i / N) * xR;
        var y = sl[i] + fa[i];
        for (var p = 0; p < sample.peaks.length; p++) {
            var pk = sample.peaks[p];
            y += pk.height * Math.exp(-((x - pk.position) * (x - pk.position)) / (2 * pk.width * pk.width));
        }
        sig[i] = y;
    }
    return sig;
}

/* ---- canvas helpers ----------------------------------------- */
function setupCanvas(rowIdx) {
    var row = rows[rowIdx];
    var rect = row.canvas.parentElement.getBoundingClientRect();
    var dpr = window.devicePixelRatio || 1;
    row.canvas.width = Math.round(rect.width * dpr);
    row.canvas.height = Math.round(rect.height * dpr);
    row.display = { w: rect.width, h: rect.height, dpr: dpr };
}

function getCtx(rowIdx) {
    var row = rows[rowIdx];
    var c = row.canvas.getContext("2d");
    c.setTransform(row.display.dpr, 0, 0, row.display.dpr, 0, 0);
    return c;
}

function pb(rowIdx) {
    var d = rows[rowIdx].display;
    return { w: d.w, h: d.h, L: MARGIN.left, R: d.w - MARGIN.right, T: MARGIN.top, B: d.h - MARGIN.bottom };
}

/* ---- drawing: y-axis ---------------------------------------- */
function drawYAxis(c, b) {
    c.strokeStyle = "#8a949e"; c.lineWidth = 1;
    c.beginPath(); c.moveTo(b.L, b.T); c.lineTo(b.L, b.B); c.stroke();
    c.save();
    c.fillStyle = "#6b7c8d"; c.font = "9px Consolas, Monaco, monospace";
    c.translate(12, (b.T + b.B) / 2);
    c.rotate(-Math.PI / 2);
    c.textAlign = "center"; c.textBaseline = "middle";
    c.fillText(CONFIG.yAxis.label + " (" + CONFIG.yAxis.unit + ")", 0, 0);
    c.restore();
}

/* ---- main render -------------------------------------------- */
function renderRow(rowIdx) {
    var row = rows[rowIdx];
    if (!row.canvas || !row.display) return;

    var c = getCtx(rowIdx);
    var b = pb(rowIdx);
    var sample = row.sample;
    var plotW = b.R - b.L, plotH = b.B - b.T;

    c.fillStyle = "#f5f6f9";
    c.fillRect(0, 0, b.w, b.h);
    drawYAxis(c, b);

    if (!row.signal || revealFrac <= 0) return;

    var f = revealFrac;
    var N = row.signal.length;
    var paperOff = b.L - (1 - f) * plotW;
    var visRight = Math.min(b.R, b.L + f * plotW);
    var penIdx = Math.min(Math.round((1 - f) * (N - 1)), N - 1);

    /* white paper */
    c.fillStyle = "#ffffff";
    c.fillRect(b.L, b.T, visRight - b.L, plotH);

    /* clip */
    c.save();
    c.beginPath(); c.rect(b.L, b.T - 1, visRight - b.L + 1, plotH + 2); c.clip();

    /* vertical grid */
    var xAxis = CONFIG.xAxis;
    c.strokeStyle = "#e4e7ea"; c.lineWidth = 0.6;
    for (var gi = 0; gi <= xAxis.ticks; gi++) {
        var gx = paperOff + (gi / xAxis.ticks) * plotW;
        if (gx < b.L - 1 || gx > visRight + 1) continue;
        c.beginPath(); c.moveTo(gx, b.T); c.lineTo(gx, b.B); c.stroke();
    }
    /* horizontal grid */
    for (var hi = 0; hi <= 4; hi++) {
        var gy = b.T + (hi / 4) * plotH;
        c.beginPath(); c.moveTo(b.L, gy); c.lineTo(visRight, gy); c.stroke();
    }

    /* x-axis line */
    c.strokeStyle = "#8a949e"; c.lineWidth = 1;
    c.beginPath(); c.moveTo(b.L, b.B); c.lineTo(visRight, b.B); c.stroke();

    /* x tick labels */
    c.fillStyle = "#6b7c8d"; c.font = "9px Consolas, Monaco, monospace";
    c.textAlign = "center"; c.textBaseline = "top";
    for (var ti = 0; ti <= xAxis.ticks; ti++) {
        var tx = paperOff + (ti / xAxis.ticks) * plotW;
        if (tx < b.L - 8 || tx > visRight + 8) continue;
        c.fillText((xAxis.min + (ti / xAxis.ticks) * (xAxis.max - xAxis.min)).toFixed(0), tx, b.B + 2);
    }
    if (visRight - b.L > 100) {
        c.fillText(xAxis.label + " (" + xAxis.unit + ")", (b.L + visRight) / 2, b.B + 13);
    }

    /* signal fill */
    c.fillStyle = sample.color + "18";
    c.beginPath();
    var started = false, lastSx = b.L;
    for (var si = 0; si < N; si++) {
        var sx = paperOff + (si / (N - 1)) * plotW;
        if (sx > visRight + 1) break;
        if (sx < b.L - 1) continue;
        var sy = b.B - (Math.max(0, row.signal[si]) / CONFIG.yAxis.max) * plotH;
        if (!started) { c.moveTo(sx, b.B); c.lineTo(sx, sy); started = true; }
        else c.lineTo(sx, sy);
        lastSx = sx;
    }
    if (started) { c.lineTo(lastSx, b.B); c.closePath(); c.fill(); }

    /* signal line */
    c.strokeStyle = sample.color; c.lineWidth = 1.6; c.lineJoin = "round";
    c.beginPath(); started = false;
    for (var si = 0; si < N; si++) {
        var sx = paperOff + (si / (N - 1)) * plotW;
        if (sx > visRight + 1) break;
        if (sx < b.L - 1) continue;
        var sy = b.B - (Math.max(0, row.signal[si]) / CONFIG.yAxis.max) * plotH;
        if (!started) { c.moveTo(sx, sy); started = true; }
        else c.lineTo(sx, sy);
    }
    c.stroke();
    c.restore(); /* end clip */

    /* paper edge shadow */
    if (visRight < b.R - 2) {
        var eg = c.createLinearGradient(visRight, 0, visRight + 4, 0);
        eg.addColorStop(0, "rgba(0,0,0,0.05)"); eg.addColorStop(1, "rgba(0,0,0,0)");
        c.fillStyle = eg; c.fillRect(visRight, b.T, 4, plotH);
        c.strokeStyle = "rgba(0,0,0,0.08)"; c.lineWidth = 0.7;
        c.beginPath(); c.moveTo(visRight, b.T); c.lineTo(visRight, b.B); c.stroke();
    }

    /* pen dot */
    if (f > 0.005 && f < 1) {
        var penY = b.B - (Math.max(0, row.signal[penIdx]) / CONFIG.yAxis.max) * plotH;
        c.beginPath(); c.arc(b.L, penY, 5, 0, Math.PI * 2);
        c.fillStyle = sample.color + "28"; c.fill();
        c.beginPath(); c.arc(b.L, penY, 2.5, 0, Math.PI * 2);
        c.fillStyle = sample.color; c.fill();
        c.strokeStyle = "#fff"; c.lineWidth = 1.2; c.stroke();
    }

    /* hover highlight */
    if (row.hoveredPeak) {
        var pk = row.hoveredPeak;
        var xFrac = (pk.position - CONFIG.xAxis.min) / (CONFIG.xAxis.max - CONFIG.xAxis.min);
        var hx = paperOff + xFrac * plotW;
        if (hx >= b.L && hx <= visRight) {
            var hy = b.B - (pk.height / CONFIG.yAxis.max) * plotH;
            c.strokeStyle = sample.color + "55"; c.lineWidth = 1; c.setLineDash([3, 3]);
            c.beginPath(); c.moveTo(hx, b.B); c.lineTo(hx, hy); c.stroke();
            c.setLineDash([]);
            c.beginPath(); c.arc(hx, hy, 4, 0, Math.PI * 2);
            c.fillStyle = sample.color; c.fill();
            c.strokeStyle = "#fff"; c.lineWidth = 1.5; c.stroke();
        }
    }
}

function renderAll() { renderRow(0); renderRow(1); }

/* ---- page transitions --------------------------------------- */
var page1 = document.getElementById("page1");
var page2 = document.getElementById("page2");

function showPage(num) {
    if (num === 1) { page2.classList.add("hidden"); page1.classList.remove("hidden"); }
    else { page1.classList.add("hidden"); page2.classList.remove("hidden"); }
}

/* ---- site selection ----------------------------------------- */
function selectSite(siteIdx) {
    selectedSiteIndex = siteIdx;
    var site = SAMPLES[siteIdx];

    document.getElementById("p2Title").textContent = site.name + "  vs  R\u00e9f\u00e9rence";
    document.getElementById("p2Sub").textContent =
        "\u00c9ch. " + site.subtitle + " \u2014 Contr\u00f4le : " + SAMPLES[0].name;

    rows[0].sample = SAMPLES[0];
    rows[1].sample = SAMPLES[siteIdx];

    var card0 = document.getElementById("card0");
    card0.style.background = SAMPLES[0].cardBg;
    card0.innerHTML =
        '<div class="code" style="background:' + SAMPLES[0].color + '">' + SAMPLES[0].code + '</div>' +
        '<div class="name">' + SAMPLES[0].name + '</div>' +
        '<div class="subtitle">' + SAMPLES[0].subtitle + '</div>';

    var card1 = document.getElementById("card1");
    card1.style.background = site.cardBg;
    card1.innerHTML =
        '<div class="code" style="background:' + site.color + '">' + site.code + '</div>' +
        '<div class="name">' + site.name + '</div>' +
        '<div class="subtitle">' + site.subtitle + '</div>';

    showPage(2);

    setTimeout(function() {
        if (animRafId) cancelAnimationFrame(animRafId);
        animating = false;
        revealFrac = 0;
        rows[0].signal = null;
        rows[1].signal = null;
        rows[0].hoveredPeak = null;
        rows[1].hoveredPeak = null;

        rows[0].canvas = document.getElementById("canvas0");
        rows[1].canvas = document.getElementById("canvas1");

        setupCanvas(0);
        setupCanvas(1);
        renderAll();

        document.getElementById("hint0").classList.remove("hidden");
        document.getElementById("hint1").classList.remove("hidden");
    }, 60);
}

function goBack() {
    if (animRafId) cancelAnimationFrame(animRafId);
    animating = false;
    revealFrac = 0;
    rows[0].hoveredPeak = null;
    rows[1].hoveredPeak = null;
    tooltip.className = "hidden";
    showPage(1);
}

/* ---- animation (both rows simultaneously) ------------------- */
function analyzeBoth() {
    if (animating) return;

    revealFrac = 0;
    rows[0].signal = genSignal(rows[0].sample);
    rows[1].signal = genSignal(rows[1].sample);
    rows[0].hoveredPeak = null;
    rows[1].hoveredPeak = null;
    tooltip.className = "hidden";

    document.getElementById("hint0").classList.add("hidden");
    document.getElementById("hint1").classList.add("hidden");

    animating = true;
    var startTime = performance.now();

    function frame(now) {
        revealFrac = Math.min((now - startTime) / CONFIG.animationDuration, 1);
        renderAll();
        if (revealFrac < 1) {
            animRafId = requestAnimationFrame(frame);
        } else {
            animating = false;
            animRafId = null;
        }
    }
    animRafId = requestAnimationFrame(frame);
}

function resetBoth() {
    if (animRafId) cancelAnimationFrame(animRafId);
    animating = false;
    revealFrac = 0;
    rows[0].signal = null;
    rows[1].signal = null;
    rows[0].hoveredPeak = null;
    rows[1].hoveredPeak = null;
    tooltip.className = "hidden";

    document.getElementById("hint0").classList.remove("hidden");
    document.getElementById("hint1").classList.remove("hidden");

    renderAll();
}

/* ---- tooltip hover (no reveal control) ---------------------- */
function setupGraphEvents() {
    [0, 1].forEach(function(rowIdx) {
        var ga = document.getElementById("graphArea" + rowIdx);

        ga.addEventListener("mousemove", function(e) {
            var row = rows[rowIdx];
            if (!row.signal || !row.display) return;

            var rect = row.canvas.parentElement.getBoundingClientRect();
            var mx = e.clientX - rect.left, my = e.clientY - rect.top;
            var b = pb(rowIdx);
            var plotW = b.R - b.L, plotH = b.B - b.T;
            var paperOff = b.L - (1 - revealFrac) * plotW;
            var visRight = Math.min(b.R, b.L + revealFrac * plotW);

            var best = null, bestDist = 22;
            for (var pi = 0; pi < row.sample.peaks.length; pi++) {
                var pk = row.sample.peaks[pi];
                var xF = (pk.position - CONFIG.xAxis.min) / (CONFIG.xAxis.max - CONFIG.xAxis.min);
                var px = paperOff + xF * plotW;
                if (px < b.L || px > visRight) continue;
                var py = b.B - (pk.height / CONFIG.yAxis.max) * plotH;
                var d = Math.sqrt((mx - px) * (mx - px) + (my - py) * (my - py));
                if (d < bestDist) { bestDist = d; best = pk; }
            }

            var changed = row.hoveredPeak !== best;
            row.hoveredPeak = best;

            if (best) {
                tooltip.className = "";
                tooltip.innerHTML =
                    '<div class="tt-name">' + best.label + '</div>' +
                    '<div class="tt-value">' + best.height + " " + CONFIG.yAxis.unit +
                    " @ " + best.position + " " + CONFIG.xAxis.unit + '</div>';
                tooltip.style.left = e.clientX + "px";
                tooltip.style.top = e.clientY + "px";
            } else {
                tooltip.className = "hidden";
            }
            if (changed && !animating) renderAll();
        });

        ga.addEventListener("mouseleave", function() {
            var row = rows[rowIdx];
            if (row.hoveredPeak) {
                row.hoveredPeak = null;
                tooltip.className = "hidden";
                if (!animating) renderAll();
            }
        });
    });
}

/* ---- resize ------------------------------------------------- */
function handleResize() {
    if (page2.classList.contains("hidden")) return;
    if (rows[0].canvas && rows[0].display) {
        setupCanvas(0); setupCanvas(1); renderAll();
    }
}

/* ---- init --------------------------------------------------- */
window.addEventListener("load", function() {
    setupGraphEvents();
    for (var i = 1; i <= 3; i++) {
        document.getElementById("zname" + i).textContent = SAMPLES[i].name;
        document.getElementById("zloc" + i).textContent = SAMPLES[i].location;
    }
    showPage(1);
});
window.addEventListener("resize", handleResize);
</script>
</body>
</html>
